<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Storage</title>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://dnuvhvcnwmbjttmitcwr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRudXZodmNud21ianR0bWl0Y3dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3OTg1NDQsImV4cCI6MjA3NTM3NDU0NH0.KhDCEqwTX-1h2EUT7cy3AvoJoTt7ElCD80Boxf-uVHI';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabase = supabase;

const BUCKET = 'my-storage';
const UPLOAD_FOLDER = 'uploads/';
const VIEW_ID = '12321';

const $ = sel => document.querySelector(sel);
const showError = msg => { $('#uploadError').textContent = msg || ''; };

// Upload file
async function doUpload(file){
    if(!file) return showError('No file selected');
    showError('');
    const progressContainer = $('#progressContainer');
    const progressBar = $('#uploadProgress');
    const progressText = $('#progressText');
    progressBar.value = 0;
    progressText.textContent = '0%';
    progressContainer.style.display = 'flex';

    const path = `${UPLOAD_FOLDER}${file.name}`;
    try {
        const { data, error } = await supabase.storage.from(BUCKET).upload(path, file, { upsert: true });
        if(error) throw error;
        progressBar.value = 100;
        progressText.textContent = '100%';
        setTimeout(()=>{ progressContainer.style.display='none'; listFiles(); },400);
    } catch(err){
        progressContainer.style.display='none';
        showError('Upload failed: '+(err.message||err));
        console.error(err);
    }
}

// List files
async function listFiles(){
    const container = $('#fileList');
    container.innerHTML = '';
    showError('');
    try{
        const { data: files, error } = await supabase.storage.from(BUCKET).list(UPLOAD_FOLDER, { limit:200 });
        if(error) throw error;
        if(!files || files.length===0){ container.innerHTML='<div class="empty">No files uploaded yet.</div>'; return; }
        files.sort((a,b)=>a.name.localeCompare(b.name,{numeric:true,sensitivity:'base'}));
        for(const f of files){
            const filePath = `${UPLOAD_FOLDER}${f.name}`;
            const { data: publicData } = supabase.storage.from(BUCKET).getPublicUrl(filePath);
            const isImg = /\.(jpe?g|png|gif|webp)$/i.test(f.name);
            const card = document.createElement('div'); 
            card.className='file-card';
            card.dataset.url = isImg? publicData.publicUrl : '';
            card.innerHTML=`
                <div class="file-preview">
                    ${isImg?`<img src="${publicData.publicUrl}" class="preview" />`:'<div class="file-placeholder">File</div>'}
                </div>
                <div class="file-name" title="${f.name}">${f.name}</div>
                <div class="file-actions">
                    <a class="btn small" target="_blank" href="${publicData.publicUrl}">Download</a>
                    <button class="btn small danger" data-f="${f.name}">Delete</button>
                    <button class="btn small rename" data-f="${f.name}">Rename</button>
                </div>
            `;
            container.appendChild(card);
        }
    } catch(err){ container.innerHTML='Failed to load files: '+(err.message||err); console.error(err);}
}

// Delete file
async function deleteFile(fileName){
    if(!confirm(`Delete "${fileName}"?`)) return;
    showError('');
    try{ const { error } = await supabase.storage.from(BUCKET).remove([`${UPLOAD_FOLDER}${fileName}`]); if(error) throw error; listFiles(); }
    catch(err){ showError('Delete failed: '+(err.message||err)); console.error(err);}
}

// Rename file
async function renameFile(oldName){
    const newName = prompt('Enter new name for '+oldName, oldName);
    if(!newName || newName===oldName) return;
    try{
        const oldPath = `${UPLOAD_FOLDER}${oldName}`;
        const newPath = `${UPLOAD_FOLDER}${newName}`;
        const { error } = await supabase.storage.from(BUCKET).move(oldPath,newPath);
        if(error) throw error;
        listFiles();
    }catch(err){ showError('Rename failed: '+(err.message||err)); console.error(err);}
}

// Drag & drop upload
function setupDragDrop(){
    const dropArea = $('#fileList');
    dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.classList.add('dragover'); });
    dropArea.addEventListener('dragleave', e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); });
    dropArea.addEventListener('drop', e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); const file=e.dataTransfer.files[0]; if(file) doUpload(file); });
}

// Login system
function doLogin(){
    const val = $('#viewId').value.trim();
    if(val===VIEW_ID){ sessionStorage.setItem('loggedIn','true'); renderApp(); }
    else $('#loginError').textContent='Incorrect View ID';
}
function doLogout(){ sessionStorage.removeItem('loggedIn'); renderApp(); }

// Render app
function renderApp(){
    const logged = sessionStorage.getItem('loggedIn')==='true';
    $('#loginPage').style.display = logged?'none':'flex';
    $('#appPage').style.display = logged?'flex':'none';
    if(logged){ listFiles(); if(window._refreshInterval) clearInterval(window._refreshInterval); window._refreshInterval=setInterval(listFiles,5*60*1000);}
    else { if(window._refreshInterval){ clearInterval(window._refreshInterval); window._refreshInterval=null; } }
}

// Image modal
function setupImageModal(){
    const modal = $('#imageModal');
    const modalImg = $('#modalImg');

    $('#fileList').addEventListener('click', e=>{
        const card = e.target.closest('.file-card');
        if(card && !e.target.closest('button') && card.dataset.url){
            modalImg.src = card.dataset.url;
            modal.style.display = 'flex';
            setTimeout(()=> modal.style.opacity=1, 20);
        }
    });

    modal.addEventListener('click', e=>{
        if(e.target===modal || e.target.id==='closeModal'){
            modal.style.opacity=0;
            setTimeout(()=>{ modal.style.display='none'; modalImg.src=''; }, 200);
        }
    });

    document.addEventListener('keydown', e=>{
        if(e.key==='Escape' && modal.style.display==='flex'){
            modal.style.opacity=0;
            setTimeout(()=>{ modal.style.display='none'; modalImg.src=''; }, 200);
        }
    });
}

window.addEventListener('load',()=>{
    $('#loginBtn').addEventListener('click',doLogin);
    $('#viewId').addEventListener('keydown',e=>{if(e.key==='Enter') doLogin();});
    $('#logoutBtn').addEventListener('click',doLogout);
    $('#uploadBtn').addEventListener('click',()=>{const f=$('#fileInput').files[0]; if(f) doUpload(f);});
    $('#refreshBtn').addEventListener('click',listFiles);
    $('#fileInput').addEventListener('change',()=>{$('#selectedName').textContent=$('#fileInput').files[0].name;});
    $('#fileList').addEventListener('click',e=>{
        const del = e.target.closest('button.danger'); if(del) deleteFile(del.dataset.f);
        const ren = e.target.closest('button.rename'); if(ren) renameFile(ren.dataset.f);
    });
    setupDragDrop();
    setupImageModal();
    renderApp();
});
</script>

<style>
:root{
  --bg:#0f0f17;
  --bg2:#1a1a2b;
  --accent:#ff4c4c;
  --card:#222238;
  --muted:#888;
  --danger:#ff4c4c;
  --radius:16px;
  font-family: 'Segoe UI', sans-serif;
}
html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bg),var(--bg2));color:#fff;overflow:hidden;}
.app-wrap{height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:10px;}

/* LOGIN */
#loginPage{display:flex;align-items:center;justify-content:center;flex-direction:column;width:100%;height:100%;}
.login-box{background:rgba(34,34,56,0.9);padding:40px;border-radius:var(--radius);backdrop-filter:blur(6px);width:360px;text-align:center;}
.login-box h1{margin:0 0 18px;font-size:26px;}
.input{width:100%;padding:12px;border-radius:var(--radius);border:none;background:#444;color:#fff;margin-bottom:12px;outline:none;}
.btn{background:var(--accent);color:#111;padding:10px 14px;border-radius:var(--radius);border:none;cursor:pointer;font-weight:600;transition:.2s;}
.btn:hover{opacity:.85;}
.btn.secondary{background:#444;color:#fff;}
.btn.danger{background:var(--danger);color:#fff;}
.small{padding:6px 8px;font-size:13px;}
.error{color:var(--danger);margin-top:10px;min-height:18px;}

/* APP */
#appPage{display:flex;flex-direction:column;width:100%;height:100%;padding:10px;}
header{background:var(--card);padding:16px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;border-radius:var(--radius);}
header h2{margin:0;color:var(--accent);}
header .controls{display:flex;gap:12px;align-items:center;}
header .controls input[type="file"]{display:none;}
header label.file-btn{padding:10px 14px;background:var(--accent);color:#111;border-radius:var(--radius);cursor:pointer;font-weight:600;transition:.2s;}
header label.file-btn:hover{opacity:.85;}

/* Files container rectangle */
#fileList{flex:1;max-width:1000px;max-height:600px;margin:20px auto;overflow-y:auto;padding:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;background:var(--card);border-radius:var(--radius);}

/* File cards */
.file-card{background:#333;border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;transition:.2s;cursor:pointer;}
.file-card:hover{transform:translateY(-3px);box-shadow:0 4px 20px rgba(255,76,76,0.3);}
.file-preview img.preview{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:var(--radius);}
.file-placeholder{width:100%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#444;border-radius:var(--radius);}
.file-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:14px;text-align:center;width:100%;}
.file-actions{display:flex;gap:8px;justify-content:center;width:100%;flex-wrap:wrap;}
.dragover{outline:3px dashed var(--accent);border-radius:var(--radius);}
.empty{text-align:center;color:var(--muted);width:100%;margin-top:40px;}
#progressContainer{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);padding:20px;border-radius:var(--radius);display:none;flex-direction:column;align-items:center;gap:10px;z-index:1000;}
#uploadProgress{width:220px;height:12px;border-radius:var(--radius);}
#progressText{color:var(--accent);font-weight:600;}

/* Modal */
#imageModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:2000;opacity:0;transition:.2s;}
#imageModal img{max-width:90%;max-height:90%;border-radius:var(--radius);}
#closeModal{position:absolute;top:20px;right:20px;padding:10px 14px;background:var(--accent);border:none;border-radius:var(--radius);cursor:pointer;color:#111;font-weight:600;}
</style>

<div class="app-wrap">
  <div id="loginPage">
    <div class="login-box">
      <h1>Enter View ID</h1>
      <input id="viewId" class="input" type="password" placeholder="••••">
      <button id="loginBtn" class="btn">Log In</button>
      <div id="loginError" class="error"></div>
    </div>
  </div>

  <div id="appPage" style="display:none;">
    <header>
      <h2>My Storage</h2>
      <div class="controls">
        <input type="file" id="fileInput">
        <label for="fileInput" class="file-btn">Choose File</label>
        <button id="uploadBtn" class="btn small">Upload</button>
        <button id="refreshBtn" class="btn small secondary">Refresh</button>
        <button id="logoutBtn" class="btn small secondary">Logout</button>
      </div>
    </header>
    <div id="fileList"></div>
  </div>

  <div id="progressContainer">
    <progress id="uploadProgress" value="0" max="100"></progress>
    <div id="progressText">0%</div>
    <div id="uploadError" class="error"></div>
  </div>

  <div id="imageModal">
    <button id="closeModal">Close</button>
    <img id="modalImg" src="">
  </div>
</div>
