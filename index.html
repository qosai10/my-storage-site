<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Storage</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://dnuvhvcnwmbjttmitcwr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRudXZodmNud21ianR0bWl0Y3dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3OTg1NDQsImV4cCI6MjA3NTM3NDU0NH0.KhDCEqwTX-1h2EUT7cy3AvoJoTt7ElCD80Boxf-uVHI";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const BUCKET = "my-storage";
const FOLDER = "uploads/";
const VIEW_ID = "12321";

const $ = (sel) => document.querySelector(sel);
const showError = (msg) => ($("#uploadError").textContent = msg || "");

async function uploadFile(file) {
  if (!file) return showError("No file selected.");
  showError("");
  $("#uploadProgress").value = 0;
  $("#progressContainer").style.display = "flex";

  const path = `${FOLDER}${file.name}`;
  try {
    const { error } = await supabase.storage.from(BUCKET).upload(path, file, { upsert: true });
    if (error) throw error;
    $("#uploadProgress").value = 100;
    setTimeout(() => {
      $("#progressContainer").style.display = "none";
      listFiles();
    }, 600);
  } catch (err) {
    $("#progressContainer").style.display = "none";
    showError("Upload failed: " + err.message);
  }
}

async function listFiles() {
  const list = $("#fileList");
  list.innerHTML = "";
  const { data: files, error } = await supabase.storage.from(BUCKET).list(FOLDER);
  if (error) return showError("Failed to load files: " + error.message);

  if (!files || files.length === 0) {
    list.innerHTML = '<div class="empty">No files uploaded yet.</div>';
    return;
  }

  for (const f of files) {
    const filePath = `${FOLDER}${f.name}`;
    const { data } = supabase.storage.from(BUCKET).getPublicUrl(filePath);
    const url = data.publicUrl;
    const isImage = /\.(jpe?g|png|gif|webp)$/i.test(f.name);

    const card = document.createElement("div");
    card.className = "file-card";
    card.innerHTML = `
      ${isImage ? `<img src="${url}" alt="${f.name}" class="preview" />` : `<div class="file-icon">ðŸ“„</div>`}
      <div class="file-name">${f.name}</div>
      <div class="file-actions">
        <button class="btn small danger" data-del="${f.name}">Delete</button>
        <button class="btn small rename" data-ren="${f.name}">Rename</button>
        <a class="btn small secondary" href="${url}" target="_blank">Download</a>
      </div>
    `;
    list.appendChild(card);
  }
}

async function deleteFile(name) {
  if (!confirm(`Delete "${name}"?`)) return;
  const { error } = await supabase.storage.from(BUCKET).remove([`${FOLDER}${name}`]);
  if (error) return showError("Delete failed: " + error.message);
  listFiles();
}

async function renameFile(oldName) {
  const newName = prompt("Enter new name:", oldName);
  if (!newName || newName === oldName) return;
  const from = `${FOLDER}${oldName}`;
  const to = `${FOLDER}${newName}`;
  const { error } = await supabase.storage.from(BUCKET).move(from, to);
  if (error) return showError("Rename failed: " + error.message);
  listFiles();
}

function doLogin() {
  const id = $("#viewId").value.trim();
  if (id === VIEW_ID) {
    sessionStorage.setItem("loggedIn", "true");
    renderApp();
  } else $("#loginError").textContent = "Incorrect ID";
}

function doLogout() {
  sessionStorage.removeItem("loggedIn");
  renderApp();
}

function renderApp() {
  const logged = sessionStorage.getItem("loggedIn") === "true";
  $("#loginPage").style.display = logged ? "none" : "flex";
  $("#appPage").style.display = logged ? "flex" : "none";
  if (logged) listFiles();
}

window.addEventListener("load", () => {
  $("#loginBtn").addEventListener("click", doLogin);
  $("#viewId").addEventListener("keydown", (e) => e.key === "Enter" && doLogin());
  $("#logoutBtn").addEventListener("click", doLogout);
  $("#uploadBtn").addEventListener("click", () => {
    const f = $("#fileInput").files[0];
    if (f) uploadFile(f);
  });
  $("#fileList").addEventListener("click", (e) => {
    const del = e.target.dataset.del;
    const ren = e.target.dataset.ren;
    if (del) deleteFile(del);
    if (ren) renameFile(ren);
  });
  $("#fileList").addEventListener("click", (e) => {
    const img = e.target.closest(".preview");
    if (!img) return;
    $("#modalImg").src = img.src;
    $("#imgModal").style.display = "flex";
  });
  $("#closeModal").addEventListener("click", () => ($("#imgModal").style.display = "none"));
  renderApp();
});
</script>

<style>
:root {
  --bg: #120707;
  --card: #1d0b0b;
  --accent: #ff4c4c;
  --text: #fff;
  --radius: 14px;
}

body, html {
  margin: 0;
  height: 100%;
  background: linear-gradient(160deg, var(--bg), #2c0e0e);
  color: var(--text);
  font-family: "Segoe UI", sans-serif;
  overflow: hidden;
}

.app-wrap {
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* LOGIN */
#loginPage {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.login-box {
  background: var(--card);
  padding: 40px;
  border-radius: var(--radius);
  text-align: center;
}

.input {
  width: 100%;
  padding: 10px;
  border-radius: var(--radius);
  border: none;
  outline: none;
  background: #311212;
  color: white;
}

.btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 10px 16px;
  cursor: pointer;
  transition: 0.2s;
}

.btn:hover {
  opacity: 0.85;
}

.btn.secondary {
  background: #333;
}

.btn.danger {
  background: #c62828;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--card);
  padding: 16px 24px;
  border-radius: var(--radius);
}

#fileList {
  flex: 1;
  padding: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  grid-template-rows: repeat(5, 1fr);
  gap: 14px;
  overflow-y: auto;
}

.file-card {
  background: var(--card);
  border-radius: var(--radius);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  aspect-ratio: 1 / 1;
  transition: 0.2s;
}

.file-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
}

.file-card img.preview {
  width: 100%;
  height: 70%;
  object-fit: cover;
  border-radius: var(--radius);
  cursor: pointer;
}

.file-actions {
  display: flex;
  justify-content: space-between;
  width: 100%;
  gap: 6px;
}

.file-name {
  font-size: 12px;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  margin: 4px 0;
}

/* MODAL */
#imgModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

#imgModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: var(--radius);
}

#closeModal {
  position: absolute;
  top: 20px; right: 30px;
  font-size: 28px;
  cursor: pointer;
  color: white;
}
</style>
</head>

<body>
<div class="app-wrap">
  <div id="loginPage">
    <div class="login-box">
      <h2>Enter View ID</h2>
      <input id="viewId" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢">
      <button id="loginBtn" class="btn">Log In</button>
      <div id="loginError" class="error"></div>
    </div>
  </div>

  <div id="appPage" style="display:none;flex-direction:column;width:100%;height:100%;">
    <header>
      <h2>My Storage</h2>
      <div>
        <input type="file" id="fileInput" style="display:none;">
        <button id="uploadBtn" class="btn">Upload</button>
        <button id="refreshBtn" class="btn secondary" onclick="location.reload()">Refresh</button>
        <button id="logoutBtn" class="btn secondary">Logout</button>
      </div>
    </header>
    <div id="fileList"></div>
  </div>

  <div id="progressContainer" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);padding:20px;border-radius:var(--radius);">
    <progress id="uploadProgress" value="0" max="100" style="width:220px;"></progress>
    <div id="uploadError" class="error"></div>
  </div>

  <div id="imgModal">
    <span id="closeModal">Ã—</span>
    <img id="modalImg" src="">
  </div>
</div>
</body>
</html>
